<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Quran Runner – Al-Fatihah</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link href="https://fonts.googleapis.com/css2?family=Amiri&display=swap" rel="stylesheet">

<style>
body {
  margin: 0;
  background: linear-gradient(#0c0c0c, #000);
  color: #fff;
  font-family: Arial, sans-serif;
  overflow: hidden;
}

#startScreen {
  position: absolute;
  inset: 0;
  background: #000;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  z-index: 20;
}

#ui {
  position: absolute;
  top: 10px;
  width: 100%;
  display: flex;
  justify-content: space-around;
  z-index: 10;
  font-size: 14px;
}

#progressContainer {
  position: absolute;
  top: 50px;
  left: 10%;
  width: 80%;
  height: 10px;
  background: #333;
  border-radius: 5px;
}

#progressBar {
  height: 100%;
  width: 0%;
  background: #1e88e5;
  border-radius: 5px;
}

#speedControl {
  position: absolute;
  bottom: 20px;
  left: 50%;
  transform: translateX(-50%);
  z-index: 10;
}

canvas {
  display: block;
  margin: 0 auto;
  background: transparent;
}

button {
  padding: 12px 24px;
  font-size: 16px;
  background: #1e88e5;
  color: #fff;
  border: none;
  border-radius: 6px;
  cursor: pointer;
}
</style>
</head>

<body>

<div id="startScreen">
  <h1>Quran Runner</h1>
  <p>Al-Fatihah</p>
  <p>Gunakan ⬅️ ➡️</p>
  <button id="startBtn">Mulai</button>
</div>

<div id="ui">
  <div>Ayat: <span id="ayatInfo">1</span>/7</div>
  <div>Potongan: <span id="pieceInfo">1</span></div>
</div>

<div id="progressContainer">
  <div id="progressBar"></div>
</div>

<div id="speedControl">
  Speed:
  <input type="range" min="0.5" max="2" step="0.1" value="1" id="speedSlider">
</div>

<canvas id="game" width="600" height="800"></canvas>

<script>
const AUDIO_SRC = 'alfatihah.mp3';

const verseTimeline = [
  { start: 0.5, pieces: ["بِسْمِ", "اللَّهِ", "الرَّحْمَٰنِ", "الرَّحِيمِ"] },
  { start: 4.5, pieces: ["الْحَمْدُ", "لِلَّهِ", "رَبِّ", "الْعَالَمِينَ"] },
  { start: 9.5, pieces: ["الرَّحْمَٰنِ", "الرَّحِيمِ"] },
  { start: 13.5, pieces: ["مَالِكِ", "يَوْمِ", "الدِّينِ"] },
  { start: 18.0, pieces: ["إِيَّاكَ", "نَعْبُدُ", "وَإِيَّاكَ", "نَسْتَعِينُ"] },
  { start: 24.0, pieces: ["اهْدِنَا", "الصِّرَاطَ", "الْمُسْتَقِيمَ"] },
  { start: 29.5, pieces: ["صِرَاطَ", "الَّذِينَ", "أَنْعَمْتَ", "عَلَيْهِمْ"] }
];

const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');

const lanes = [200, 300, 400];
let playerLane = 1;

let verseIndex = 0;
let pieceIndex = 0;
let pieceY = -50;

let speedMultiplier = 1;
const BASE_SPEED = 90;

let audioCtx, buffer, source, startTime;

function loadAudio() {
  audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  return fetch(AUDIO_SRC)
    .then(r => r.arrayBuffer())
    .then(b => audioCtx.decodeAudioData(b))
    .then(buf => buffer = buf);
}

function playAudio() {
  source = audioCtx.createBufferSource();
  source.buffer = buffer;
  source.connect(audioCtx.destination);
  startTime = audioCtx.currentTime;
  source.start();
}

function audioTime() {
  return audioCtx.currentTime - startTime;
}

function updateUI() {
  document.getElementById('ayatInfo').textContent = verseIndex + 1;
  document.getElementById('pieceInfo').textContent =
    (pieceIndex + 1) + "/" + verseTimeline[verseIndex].pieces.length;

  const total = verseTimeline.reduce((a,v)=>a+v.pieces.length,0);
  const done = verseTimeline.slice(0,verseIndex)
    .reduce((a,v)=>a+v.pieces.length,0) + pieceIndex;

  document.getElementById('progressBar').style.width =
    (done / total * 100) + "%";
}

function loop() {
  ctx.clearRect(0,0,600,800);

  ctx.fillStyle = '#1e88e5';
  ctx.fillRect(lanes[playerLane]-30,650,60,80);

  if (verseIndex < verseTimeline.length) {
    ctx.font = '36px Amiri';
    ctx.textAlign = 'center';
    ctx.fillStyle = '#ffffff';

    ctx.fillText(
      verseTimeline[verseIndex].pieces[pieceIndex],
      lanes[2],
      pieceY
    );

    pieceY += BASE_SPEED * speedMultiplier * 0.016;

    if (pieceY > 650 && playerLane === 2) {
      pieceIndex++;
      pieceY = -50;

      if (pieceIndex >= verseTimeline[verseIndex].pieces.length) {
        verseIndex++;
        pieceIndex = 0;
      }
      updateUI();
    }
  }

  requestAnimationFrame(loop);
}

document.addEventListener('keydown', e => {
  if (e.key === 'ArrowLeft') playerLane = Math.max(0, playerLane - 1);
  if (e.key === 'ArrowRight') playerLane = Math.min(2, playerLane + 1);
});

document.getElementById('speedSlider').oninput = e => {
  speedMultiplier = parseFloat(e.target.value);
};

document.getElementById('startBtn').onclick = async () => {
  document.getElementById('startScreen').style.display = 'none';
  await loadAudio();
  playAudio();
  updateUI();
  loop();
};
</script>

</body>
</html>
